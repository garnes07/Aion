@model Aion.Areas.Admin.ViewModels.Recruitment.RecruitmentSummaryVm

@{
    ViewBag.Title = "Recruitment";
    int previousStore = 0;
    string previousChain = "";
    int previousRole = 0;
}

<div class="modal fade" id="toRaiseModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">To Be Raised</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div id="mBody" class="modal-body">
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="mSubmit" type="button" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div id="accordion" class="card-accordion">
        <div class="card">
            <div class="card-header" id="headerOne">
                <button class="btn btn-link" data-toggle="collapse" data-target="@(Model.IncorrectCount > 0 ? "#collapseOne" : "")">Incorrect Requests to Delete - <strong>(@Model.IncorrectCount)</strong></button>
            </div>
            <div id="collapseOne" class="collapse" data-parent="#accordion">
                <div class="card-body">
                    <div class="table-responsive" style="max-height:500px;">
                        <table class="table table-sm text-center">
                            <thead>
                                <tr>
                                    <th>Req#</th>
                                    <th>Company</th>
                                    <th>Store#</th>
                                    <th>Location</th>
                                    <th>Job Role</th>
                                    <th>Raising Name</th>
                                    <th>Confirm</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.IncorrectVacancies)
                                {
                                    <tr>
                                        <td><small>@item.Job_Req_ID</small></td>
                                        <td><small>@item.Company</small></td>
                                        <td><small>@item.Store_Number</small></td>
                                        <td><small>@item.Location</small></td>
                                        <td><small>@item.Created_by</small></td>
                                        <td><small>@item.Job_Role</small></td>
                                        <td>
                                            <button class="btn btn-sm btn-success incorrect-delete" data-raisedby="@item.Created_by" data-jobreqid="@item.Job_Req_ID">Confirm</button>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header" id="headerTwo">
                <button class="btn btn-link" data-toggle="collapse" data-target="@(Model.ReviewCount > 0 ? "#collapseTwo" : "")">Requests To Review - <strong>(@Model.ReviewCount)</strong></button>
            </div>
            <div id="collapseTwo" class="collapse" data-parent="#accordion">
                <div class="card-body">
                    <div class="table-responsive" style="max-height:500px;">
                        <table class="table table-sm text-center">
                            <thead>
                                <tr>
                                    <th>Raised</th>
                                    <th>Ref#</th>
                                    <th>Chain</th>
                                    <th>Store#</th>
                                    <th>Position</th>
                                    <th>Review</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.ToReview)
                                {
                                    <tr>
                                        <td><small>@item.RaisedDate.ToShortDateString()</small></td>
                                        <td><small>@item.EntryId</small></td>
                                        <td><small>@item.Chain</small></td>
                                        <td><small>@item.StoreNumber</small></td>
                                        <td><small>@item.VacancyPosition.FriendlyName</small></td>
                                        @if (!(previousStore == item.StoreNumber && previousChain == item.Chain && previousRole == item.PositionCode))
                                        {
                                            <td rowspan="@Model.ToReview.Count(x => x.Chain == item.Chain && x.StoreNumber == item.StoreNumber && x.PositionCode == item.PositionCode)"><a href="@Url.Action("ReviewPending", "Recruitment", new { Chain = item.Chain, StoreNumber = item.StoreNumber, PositionCode = item.PositionCode})" class="btn btn-sm btn-success">Go</a></td>
                                        }
                                    </tr>
                                    previousStore = item.StoreNumber;
                                    previousChain = item.Chain;
                                    previousRole = item.PositionCode;
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header" id="headerThree">
                <button class="btn btn-link" data-toggle="collapse" data-target="@(Model.RaiseCount > 0 ? "#collapseThree" : "")">To be Raised - <strong>(@Model.RaiseCount)</strong></button>
            </div>
            <div id="collapseThree" class="collapse" data-parent="#accordion">
                <div class="card-body">
                    <div class="table-responsive" style="max-height:500px;">
                        <table class="table table-sm text-center">
                            <thead>
                                <tr>
                                    <th>Chain</th>
                                    <th>Store#</th>
                                    <th>Position</th>
                                    <th>Review</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.ToRaise)
                                {
                                    <tr id="@string.Format("{0}_{1}_{2}", item.Chain, item.Store, item.JobCode)">
                                        <td><small>@item.Chain</small></td>
                                        <td><small>@item.Store</small></td>
                                        <td><small>@item.FriendlyName</small></td>
                                        <td>
                                            <button 
                                                    class="btn btn-sm btn-info raiseDetail"
                                                    data-chain="@item.Chain"
                                                    data-store="@item.Store"
                                                    data-jobcode="@item.JobCode">
                                                Show Detail
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header" id="headerFour">
                <button class="btn btn-link" data-toggle="collapse" data-target="@(Model.OfferCount > 0 ? "#collapseFour" : "")">Offers to Review - <strong>(@Model.OfferCount)</strong></button>
            </div>
            <div id="collapseFour" class="collapse" data-parent="#accordion">
                <div class="card-body">
                    <div class="table-responsive" style="max-height:500px;">
                        <table class="table table-sm text-center">
                            <thead>
                                <tr>
                                    <th>Ref#</th>
                                    <th>Company</th>
                                    <th>Store#</th>
                                    <th>Position</th>
                                    <th>Review</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.OfferApprovals)
                                {
                                    <tr>
                                        <td><small>@item.Application_ID</small></td>
                                        <td><small>@item.Company</small></td>
                                        <td><small>@item.Store_Number</small></td>
                                        <td><small>@item.Job_Role</small></td>
                                        <td><a href="#" class="btn btn-sm btn-success">Go</a></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section myScripts{
    <script>
        $(function () {
            var $mBody = $('#mBody');

            $('.incorrect-delete').click(function () {
                window.location.href = "mailto:" + $(this).data('raisedby') + "?subject=Vacancy%20Cancelled%20-%20#" + $(this).data('jobreqid');
                var reqId = $(this).data('jobreqid');
                var $tRow = $(this).parent().parent();
                $.post('/Admin/Recruitment/_MarkIncorrectDone', { jobReqId: reqId}, function (result) {
                    setTimeout(function () {
                        if (result) {
                            $tRow.html('<td colspan="6" class="text-center"><strong>Done</strong></td>');
                        };
                    }, 250);
                });                
            });

            $('.raiseDetail').click(function () {
                var $trigger = $(this);
                $trigger.html('Loading...');
                var chain = $(this).data('chain');
                var store = $(this).data('store');
                var jobcode = $(this).data('jobcode');
                $.get('/Admin/Recruitment/_GetToPost', { chain: chain, store: store, jobcode: jobcode }, function (result) {
                    setTimeout(function () {
                        if (result) {
                            $('#mBody').html(result);
                            $('#toRaiseModal').modal('toggle');
                            $trigger.html('Show Detail');
                        } else {
                            $trigger.html('<i class="icon ion-sad-outline"></i>');
                        };
                    }, 250);
                });
            });

            $('#mSubmit').click(function () {
                var ref = $mBody.find('#mRef').val();
                var type = $mBody.find('#mType').val();
                if (ref.length && type.length) {
                    var chain = $mBody.find('#mChain').val();
                    var store = $mBody.find('#mStore').val();
                    var jobcode = $mBody.find('#mJobCode').val();

                    $.post('/Admin/Recruitment/_UpdateToPost', { chain: chain, store: store, jobcode: jobcode, SFRef: ref, contract: type }, function (result) {
                        setTimeout(function () {
                            if (result) {
                                $('#' + chain + '_' + store + '_' + jobcode).html('<td colspan="6" class="text-center"><strong>Done</strong></td>');
                                $('#toRaiseModal').modal('toggle');
                                $mBody.html('');
                            };
                        }, 250);
                    });
                };                
            });
        });
    </script>
}