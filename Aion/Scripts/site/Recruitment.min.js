function AllowanceDetail(n){this.RoleId=parseInt(n[0]);this.RoleAllowance=parseInt(n[1]);this.ExistingVacancyHours=parseInt(n[2]);this.FriendlyName=n[3];this.HourlyRate=parseFloat(n[4]);this.ContractBase=parseFloat(n[5]);this.ChecksVisible=!1;this.Action="new";this.Repost="true"}function findTotal(n){var t=0;return $form.find(".request").each(function(){$(this).find(".position").val()==n&&(t+=parseInt($(this).find(".rowTotal").val()))}),t}function TotalsCheck(n){var t,i;if(totalBase==-1)checkTotals(n);else for(t=[],$form.find(".position").each(function(){t.push(parseInt($(this).val()))}),i=0;i<t.length;i++)checkTotals(t[i])}function checkTotals(n){var r=roleAllowance.findAllowance(n),u=roleAllowance.findByRoleId(n),f=findTotal(n),e=u.ContractBase-r,t,i;r==-1&&u.ContractBase==0?warningBase?(t="ion-alert text-warning",i="review"):(t="ion-checkmark-round text-success",i="approved"):f+e>u.ContractBase*hoursBuffer||overBase?(t="ion-close-round text-danger",i="reject",rowErrors.indexOf(n)==-1&&rowErrors.push(n),allowSubmit=!1,$submit.addClass("disabled").attr("disabled",!0),$notes.attr("required",!1),$("#notesError").addClass("d-none"),$("#notes").removeClass("border-danger")):f>r||warningBase?(t="ion-alert text-warning",i="review",rowErrors.indexOf(n)!=-1&&rowErrors.splice(rowErrors.indexOf(n),1),rowErrors.length!==0||overBase||(allowSubmit=!0,$submit.removeClass("disabled").attr("disabled",!1),$notes.attr("required",!0)),rowWarnings.indexOf(n)==-1&&rowWarnings.push(n)):(t="ion-checkmark-round text-success",i="approved",rowErrors.indexOf(n)!=-1&&rowErrors.splice(rowErrors.indexOf(n),1),rowWarnings.indexOf(n)!=-1&&rowWarnings.splice(rowWarnings.indexOf(n),1),rowErrors.length!==0||overBase||(allowSubmit=!0,$submit.removeClass("disabled").attr("disabled",!1)),rowWarnings.length===0&&($notes.attr("required",!1),$("#notesError").addClass("d-none"),$("#notes").removeClass("border-danger")));$form.find(".request").each(function(){$(this).find(".position").val()===n&&($(this).find(".approvalResult").attr("class","approvalResult icon "+t),$(this).find(".approval").val(i))})}function AddChecks(n){for(var i,t=0;t<roleAllowance.length;t++)n.indexOf(roleAllowance[t].RoleId)!=-1?roleAllowance[t].ChecksVisible||(i=$templateCheckRow.clone(),i.attr("id",i.attr("id").replace("0",roleAllowance[t].RoleId)),i.find(".position").html(roleAllowance[t].FriendlyName),i.find(":input").each(function(){$(this).attr("name",$(this).attr("name").replace("0",roleAllowance[t].RoleId)).attr("id",$(this).attr("id").replace("0",roleAllowance[t].RoleId))}),i.find("label").each(function(){$(this).attr("for",$(this).attr("for").replace("0",roleAllowance[t].RoleId))}),$pContainer.append(i),roleAllowance[t].ChecksVisible=!0,$submit.addClass("disabled").attr("disabled",!0),checksValid=!1):($pContainer.find("#p_"+roleAllowance[t].RoleId).remove(),roleAllowance[t].ChecksVisible=!1,roleAllowance[t].Action="new",roleAllowance[t].Repost="true");$("#checkContainer").removeClass("d-none");$("html, body").animate({scrollTop:$("#formCard").offset().top},1e3)}function RemoveAllChecks(){for(var n=0;n<roleAllowance.length;n++)roleAllowance[n].ChecksVisible=!1,roleAllowance[n].Action="new",roleAllowance[n].Repost="true";$("#checkContainer").addClass("d-none")}function ValidateChecks(){var n=!0;return $pContainer.find(".pRow").each(function(){$(this).find(":input[type=radio]:checked").length==0&&(n=!1)}),n?($pContainer.find(".pRow").each(function(){var n=$(this).attr("id"),t,i;n=n.replace("p_","");t=$(this).find(":input[type=radio]:checked").val();i=$(this).find(":input[type=checkbox]").is(":checked");roleAllowance.findByRoleId(n).Action=t;roleAllowance.findByRoleId(n).Repost=i;$form.find(".request").each(function(){$(this).find(".position").val()==n&&($(this).find(".action").val(t),$(this).find(".repost").val(i))})}),!0):($("#pError").removeClass("d-none"),!1)}function CheckAgainstBase(){var t=[],i,r,n;for($form.find(".position").each(function(){t.push(parseInt($(this).val()))}),i=currentBase,r=[],n=0;n<t.length;n++)r.indexOf(t[n])==-1&&(i+=findTotal(t[n])*roleAllowance.findByRoleId(t[n]).HourlyRate,r.push(t[n]));i-=roleAllowance.VacancyToReplace();i<totalBase*1.02?($baseAlert.attr("class","alert alert-danger text-center d-none"),allowSubmit=!0,$submit.removeClass("disabled").attr("disabled",!1),$(".approvalResult").removeClass("d-none"),overBase=!1,warningBase=!1,$notes.attr("required",!1)):i<totalBase*hoursBuffer?($baseAlert.attr("class","alert alert-warning text-center d-none"),allowSubmit=!0,$submit.removeClass("disabled").attr("disabled",!1),$("#baseWarning").removeClass("d-none"),$(".approvalResult").removeClass("d-none"),$notes.attr("required",!0),warningBase=!0,overBase=!1):(allowSubmit=!1,$submit.addClass("disabled").attr("disabled",!0),$baseAlertNum.html(parseFloat(i-totalBase).toFixed(2)),$("#baseWarning").addClass("d-none"),$baseAlert.attr("class","alert alert-danger text-center"),$notes.attr("required",!1),overBase=!0,warningBase=!1)}var roleAllowance;jQuery.fn.PreventDoubleSubmission=function(){var n=$(this);return n.data("submitted")!==!0&&(n.data("submitted",!0),n.submit()),this};roleAllowance=[];roleAllowance.findByRoleId=function(n){for(var t=0;t<this.length;t++)if(this[t].RoleId==n)return this[t];return-1};roleAllowance.findAllowance=function(n){var t=this.findByRoleId(n);if(t!=-1)return t.Action==="replace"&&t.RoleAllowance!=-1&&t.ContractBase!=0?t.RoleAllowance+t.ExistingVacancyHours:t.RoleAllowance};roleAllowance.existingVacancyIds=function(n){for(var i=[],t=0;t<this.length;t++)n.indexOf(this[t].RoleId)!=-1&&this[t].ExistingVacancyHours>=1&&i.push(this[t].RoleId);return i};roleAllowance.VacancyToReplace=function(){for(var t=0,n=0;n<this.length;n++)this[n].Action==="replace"&&(t+=this[n].ExistingVacancyHours);return t};var $newRow,$templateRow,$templateCheckRow,grpCount=1,rowErrors=[],rowWarnings=[],$form=$("#rRequest"),$submit=$("#btnSubmit"),$notes=$("#notes"),$pContainer=$("#pContainer"),$baseAlert=$("#baseAlert"),$baseAlertNum=$("#baseAlertNum"),allowSubmit=!1,checksValid=!0,hoursBuffer=$("#scrpt").data("buffer"),totalBase=parseFloat($("#scrpt").data("totalbase")),currentBase=parseFloat($("#scrpt").data("currentbase")),overBase=!1,warningBase=!1,roleList;$(function(){$templateRow=$("#r_0").clone();$templateRow.find(".add").after('<i class="col text-danger icon ion-minus-circled remove" style="font-size:larger; cursor:pointer;"><\/i>');$templateCheckRow=$("#p_0").clone();$pContainer.html("");roleList=$("#scrpt").data("roledetail");for(var n=0;n<roleList.length;n++)roleAllowance.push(new AllowanceDetail(roleList[n]))});$submit.click(function(){var n=0;$form.find(".rowTotal").each(function(){n+=parseInt($(this).val())});$("#notes").attr("required")&&$("#notes").val()===""&&$("#notes").val().length<10?($("#notesError").removeClass("d-none"),$("#notes").addClass("border-danger")):($("#notesError").addClass("d-none"),$("#notes").removeClass("border-danger"),allowSubmit&&n!=0&&$form.PreventDoubleSubmission())});$form.on("change",":input",function(n){var t=$("#"+n.target.parentElement.parentElement.id),e=t.find(".heads").val()*t.find(".hours").val(),f,r;if(e>0){t.find(".rowTotal").val(e);var o=t.find(".position").val(),u=roleAllowance.findByRoleId(o),i=[];if($form.find(".position").each(function(){i.push(parseInt($(this).val()))}),f=roleAllowance.existingVacancyIds(i),n.target.classList.contains("position")||!u.ChecksVisible){if(n.target.classList.contains("position"))for(t.find(".Action").val(u.Action),t.find(".Repost").val(u.Action),t.find(".approvalResult").attr("class","approvalResult icon"),r=0;r<i.length;r++)rowErrors.indexOf(i[r])==-1&&rowErrors.splice(rowErrors.indexOf(i[r]),1),rowWarnings.indexOf(i[r])==-1&&rowWarnings.splice(rowWarnings.indexOf(i[r]),1);f.length?AddChecks(f):RemoveAllChecks()}checksValid&&(totalBase!=-1&&CheckAgainstBase(),TotalsCheck(o),overBase?$(".approvalResult").addClass("d-none"):$(".approvalResult").removeClass("d-none"))}else t.find(".rowTotal").val(0),t.find(".approvalResult").attr("class","approvalResult icon")});$pContainer.on("change",":input",function(n){var t=$("#"+n.target.parentElement.parentElement.id);t.find(".icon").attr("class","icon");checksValid=ValidateChecks();checksValid&&$form.find(".request").each(function(){var n=$(this).find(".position").val();totalBase!=-1&&CheckAgainstBase();TotalsCheck(n)})});$form.on("click",".add",function(n){var r=$("#"+n.target.parentElement.parentElement.parentElement.id),t=$templateRow.clone(),i;t.attr("id",t.attr("id").replace("0",grpCount));t.find(":input").each(function(){if(!$(this).is("[readonly]")){var n=$(this).attr("name");$(this).attr("name",n.replace("0",grpCount))}$(this).attr("name")==="RowNum"&&$(this).val(grpCount)});i=roleAllowance.findByRoleId(t.find(".position").val());i.ChecksVisible&&(t.find(".action").val(i.Action),t.find(".repost").val(i.Repost));r.after(t);grpCount++});$form.on("click",".remove",function(n){var i=$("#"+n.target.parentElement.parentElement.parentElement.id),t,r;i.remove();t=roleAllowance.findByRoleId(i.find(".position").val());r=findTotal(t.RoleId);r==0&&(t.Repost="true",t.Action="new",t.ChecksVisible=!1,$("#p_"+t.RoleId).remove());totalBase!=-1&&CheckAgainstBase();TotalsCheck(t.RoleId)});